# 换脸功能部署指南\n\n## 问题诊断结果\n\n根据logs分析，换脸功能无法使用的主要原因：\n\n### 1. 依赖库缺失\n```\n⚠️ InsightFace not available - face swap will be disabled: No module named 'insightface'\n⚠️ GFPGAN not available - face enhancement will be disabled: No module named 'gfpgan'\n```\n\n### 2. 模型文件缺失\n```\n⚠️ Face swap models not available - face swap will be disabled\n```\n\n## 解决方案\n\n### 步骤1: 安装依赖库\n\n在RunPod容器中安装换脸依赖：\n\n```bash\n# 进入容器后执行\npip install insightface onnxruntime-gpu\n\n# 可选：安装GFPGAN（如果需要面部增强）\npip install gfpgan basicsr facexlib\n```\n\n### 步骤2: 下载模型文件\n\n在RunPod环境中创建模型目录并下载必要的模型：\n\n```bash\n# 创建模型目录\nmkdir -p /runpod-volume/faceswap\ncd /runpod-volume/faceswap\n\n# 下载InsightFace模型\nwget https://github.com/deepinsight/insightface/releases/download/v0.7/buffalo_l.zip\nunzip buffalo_l.zip\n\n# 下载换脸模型\nwget https://github.com/facefusion/facefusion-assets/releases/download/models/inswapper_128_fp16.onnx\n\n# 可选：下载GFPGAN模型\nwget https://github.com/TencentARC/GFPGAN/releases/download/v1.3.0/GFPGANv1.4.pth\n```\n\n### 步骤3: 验证安装\n\n运行测试脚本验证换脸功能：\n\n```bash\ncd /app\npython -c \"\nimport handler\nprint('🔍 检查换脸功能可用性...')\nresult = handler.is_face_swap_available()\nprint(f'📝 换脸功能可用: {result}')\n\"\n```\n\n## 预期的目录结构\n\n```\n/runpod-volume/faceswap/\n├── buffalo_l/                    # InsightFace人脸分析模型\n│   ├── 1k3d68.onnx\n│   ├── 2d106det.onnx\n│   ├── det_10g.onnx\n│   ├── genderage.onnx\n│   └── w600k_r50.onnx\n├── inswapper_128_fp16.onnx        # 换脸模型\n└── GFPGANv1.4.pth                # 面部增强模型（可选）\n```\n\n## 代码修复说明\n\n### 1. 路径检测优化\n\n更新了`add_faceswap_path()`函数，优先检查RunPod路径：\n\n```python\npossible_paths = [\n    \"/runpod-volume/faceswap\",  # RunPod主要路径\n    \"/Users/baileyli/Documents/AI同志项目/image generation/faceswap\",  # 本地开发\n    \"/app/faceswap\",  # Docker容器\n    \"/workspace/faceswap\",  # RunPod备用\n    \"../faceswap\",  # 相对路径\n    \"./faceswap\"  # 当前目录\n]\n```\n\n### 2. 动态模型配置\n\n实现了`get_face_swap_models_config()`函数，动态查找模型路径：\n\n```python\ndef get_face_swap_models_config():\n    \"\"\"动态获取换脸模型路径配置\"\"\"\n    possible_base_paths = [\n        \"/runpod-volume/faceswap\",\n        \"/workspace/faceswap\", \n        \"/app/faceswap\",\n        \"./models/faceswap\",\n        \"./faceswap\"\n    ]\n    \n    for base_path in possible_base_paths:\n        if os.path.exists(base_path):\n            return {\n                \"face_swap\": os.path.join(base_path, \"inswapper_128_fp16.onnx\"),\n                \"face_enhance\": os.path.join(base_path, \"GFPGANv1.4.pth\"), \n                \"face_analysis\": os.path.join(base_path, \"buffalo_l\")\n            }\n```\n\n### 3. 增强错误诊断\n\n改进了`is_face_swap_available()`函数，提供详细的诊断信息：\n\n- 检查依赖库可用性\n- 检查模型文件存在性\n- 递归搜索可能的模型位置\n- 提供详细的错误报告\n\n### 4. Dockerfile优化\n\n更新了Dockerfile，确保换脸依赖的安装：\n\n```dockerfile\n# Install face swap dependencies separately (allows graceful failure)\nRUN pip install insightface onnxruntime-gpu || echo \"⚠️ 换脸依赖安装失败，将在运行时尝试\"\n```\n\n## 部署检查清单\n\n- [ ] 确认InsightFace库已安装\n- [ ] 确认onnxruntime-gpu已安装\n- [ ] 确认模型目录`/runpod-volume/faceswap`存在\n- [ ] 确认buffalo_l模型文件夹存在\n- [ ] 确认inswapper_128_fp16.onnx文件存在\n- [ ] 运行测试验证换脸功能可用\n\n## 故障排除\n\n### 如果依赖安装失败\n\n```bash\n# 手动安装InsightFace\npip install --upgrade pip\npip install insightface --no-deps\npip install onnxruntime-gpu\n\n# 如果还是失败，尝试CPU版本\npip install onnxruntime\n```\n\n### 如果模型下载失败\n\n可以使用备用下载链接或手动上传模型文件到RunPod volume。\n\n### 如果路径检测失败\n\n检查logs中的路径检测信息，确认模型文件放在正确的位置。\n\n## 测试命令\n\n```bash\n# 测试依赖\npython -c \"import insightface; print('InsightFace OK')\"\npython -c \"import onnxruntime; print('ONNX Runtime OK')\"\n\n# 测试路径\npython -c \"import os; print('Models exist:', os.path.exists('/runpod-volume/faceswap/inswapper_128_fp16.onnx'))\"\n\n# 完整测试\npython backend/test_face_swap_paths_fixed.py\n```\n\n## 预期结果\n\n成功配置后，logs应该显示：\n\n```\n✅ 换脸依赖库检查通过\n✅ 模型存在: face_swap at /runpod-volume/faceswap/inswapper_128_fp16.onnx\n✅ 模型存在: face_analysis at /runpod-volume/faceswap/buffalo_l\n✓ Face swap integration loaded successfully (embedded)\n```\n\n而不是：\n\n```\n⚠️ InsightFace not available - face swap will be disabled\n⚠️ Face swap models not available - face swap will be disabled\n``` 