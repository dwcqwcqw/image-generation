# ğŸš¨ æœ€ç»ˆé€’å½’é”™è¯¯ä¿®å¤æ€»ç»“

## å‘ç°çš„å…³é”®é—®é¢˜

### 1. åŒé‡é€’å½’è°ƒç”¨æ¶æ„ 
**é—®é¢˜**: ç³»ç»Ÿå­˜åœ¨å¤šå±‚é€’å½’è°ƒç”¨å¯¼è‡´æ— é™å¾ªç¯ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ handler() â†’ text_to_image() â†’ text_to_image() â†’ æ— é™é€’å½’
         â†˜ åŒæ—¶è°ƒç”¨ â†’ generate_*_images() â†’ é‡å¤å¤„ç†
```

### 2. å˜é‡ä½œç”¨åŸŸé”™è¯¯
**é—®é¢˜**: `text_to_image()` å‡½æ•°å¼•ç”¨äº†æœªå®šä¹‰çš„ `lora_config` å˜é‡
```python
# é”™è¯¯çš„å˜é‡å¼•ç”¨
if lora_config:  # âŒ å˜é‡æœªå®šä¹‰
    print(f"ğŸ¨ æ›´æ–°LoRAé…ç½®: {lora_config}")
```

### 3. æ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯
- `RecursionError: maximum recursion depth exceeded`
- `local variable 'lora_config' referenced before assignment`
- `traceback.format_exc()` æœ¬èº«å› é€’å½’è€Œå¤±è´¥

## å®æ–½çš„ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤å‡½æ•°ç­¾åå’Œå˜é‡ä½œç”¨åŸŸ
```python
# ä¿®å¤å‰
def text_to_image(prompt: str, ...):
    if lora_config:  # âŒ æœªå®šä¹‰

# ä¿®å¤å  
def text_to_image(prompt: str, ..., lora_config: dict = None):
    if lora_config is None:
        lora_config = {}
    if lora_config:  # âœ… æ­£ç¡®å®šä¹‰
```

### 2. å½»åº•é‡æ„è°ƒç”¨æ¶æ„
```python
# ä¿®å¤å‰ (åŒé‡è°ƒç”¨)
handler() â†’ text_to_image() â†’ text_to_image() â†’ é€’å½’
         â†˜ generate_*_images() â†’ é‡å¤å¤„ç†

# ä¿®å¤å (å•ä¸€è°ƒç”¨é“¾)
handler() â†’ text_to_image() â†’ generate_*_images() â†’ generate_images_common()
```

### 3. æ¶ˆé™¤Handlerä¸­çš„é‡å¤é€»è¾‘
```python
# ä¿®å¤å‰: Handlerè‡ªå·±å¤„ç†LoRA + text_to_imageä¹Ÿå¤„ç†LoRA = åŒé‡å¤„ç†
# ä¿®å¤å: Handleråªè´Ÿè´£å‚æ•°ä¼ é€’ï¼Œæ‰€æœ‰é€»è¾‘ç”±text_to_imageç»Ÿä¸€å¤„ç†
```

### 4. æ­£ç¡®çš„å‡½æ•°è°ƒç”¨é“¾
```python
# text_to_imageå‡½æ•°ä¿®å¤
if model_type == "flux":
    return generate_flux_images(...)  # âœ… ç›´æ¥è°ƒç”¨
elif model_type == "diffusers":
    return generate_diffusers_images(...)  # âœ… ç›´æ¥è°ƒç”¨
```

## ä¿®å¤æ•ˆæœé¢„æœŸ

### 1. æ¶ˆé™¤é€’å½’é”™è¯¯
- âœ… ä¸å†æœ‰ `RecursionError`
- âœ… ä¸å†æœ‰ `maximum recursion depth exceeded`
- âœ… tracebackèƒ½æ­£å¸¸å·¥ä½œ

### 2. ä¿®å¤å˜é‡ä½œç”¨åŸŸ
- âœ… `lora_config` æ­£ç¡®å®šä¹‰å’Œä¼ é€’
- âœ… ä¸å†æœ‰ `referenced before assignment` é”™è¯¯

### 3. æ¶æ„ç®€åŒ–
- âœ… å•ä¸€å¤„ç†è·¯å¾„ï¼Œé¿å…é‡å¤é€»è¾‘
- âœ… æ¸…æ™°çš„èŒè´£åˆ†å·¥
- âœ… é«˜æ•ˆçš„å‚æ•°ä¼ é€’

### 4. ç³»ç»Ÿç¨³å®šæ€§
- âœ… å‡½æ•°è°ƒç”¨æ ˆæ­£å¸¸
- âœ… å†…å­˜ä½¿ç”¨ç¨³å®š
- âœ… æ—¥å¿—è¾“å‡ºæ¸…æ™°å¯è¯»

## å…³é”®ä¿®å¤åŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ªå‡½æ•°åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šä»»åŠ¡
2. **é¿å…é‡å¤**: ç›¸åŒé€»è¾‘åªåœ¨ä¸€ä¸ªåœ°æ–¹å®ç°
3. **æ­£ç¡®å‚æ•°ä¼ é€’**: æ‰€æœ‰éœ€è¦çš„å‚æ•°éƒ½é€šè¿‡å‡½æ•°ç­¾åä¼ é€’
4. **æ¸…æ™°è°ƒç”¨é“¾**: é¿å…å¤æ‚çš„åµŒå¥—å’Œé€’å½’è°ƒç”¨

è¿™æ¬¡ä¿®å¤è§£å†³äº†ç³»ç»Ÿæ¶æ„å±‚é¢çš„æ ¹æœ¬é—®é¢˜ï¼Œåº”è¯¥èƒ½å½»åº•æ¶ˆé™¤é€’å½’é”™è¯¯ã€‚ 