# æ ¸å¿ƒé—®é¢˜ä¿®å¤ï¼šLoRAåŠ è½½å†²çªå’Œæ®‹å›¾é—®é¢˜

## ğŸš¨ ä¿®å¤çš„å…³é”®é—®é¢˜

### 1. è‡ªåŠ¨åŠ è½½é»˜è®¤LoRAé—®é¢˜ âŒ â†’ âœ…

**é—®é¢˜æè¿°:**
- ç³»ç»Ÿæ€»æ˜¯è‡ªåŠ¨åŠ è½½é…ç½®ä¸­çš„é»˜è®¤LoRA(`gayporn`)ï¼Œè€Œä¸æ˜¯ç”¨æˆ·é€‰æ‹©çš„LoRA
- ç”¨æˆ·é€‰æ‹©`furry`æ—¶ï¼Œç³»ç»Ÿå…ˆåŠ è½½`gayporn`ï¼Œå†å°è¯•åŠ è½½`furry`å¯¼è‡´å†²çª
- å‰ç«¯æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©ï¼Œä½†åç«¯å®é™…åŠ è½½çš„æ˜¯é»˜è®¤LoRA

**æ ¹æœ¬åŸå› :**
```python
# âŒ é”™è¯¯çš„é…ç½®
"anime": {
    "lora_path": "/runpod-volume/cartoon/lora/Gayporn.safetensors", # å¼ºåˆ¶é»˜è®¤LoRA
    "lora_id": "gayporn"  # å›ºå®šé»˜è®¤ID
}
DEFAULT_LORA_CONFIG = {"gayporn": 1.0}  # å¼ºåˆ¶é»˜è®¤é…ç½®
```

**ä¿®å¤æ–¹æ¡ˆ:**
```python
# âœ… ä¿®å¤åçš„é…ç½®
"anime": {
    "lora_path": None,  # ä¸è‡ªåŠ¨åŠ è½½LoRA
    "lora_id": None     # è®©ç”¨æˆ·é€‰æ‹©å†³å®š
}
DEFAULT_LORA_CONFIG = {}  # ç©ºé…ç½®ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
```

### 2. LoRAé€‚é…å™¨åç§°å†²çªé—®é¢˜ âŒ â†’ âœ…

**é—®é¢˜ç—‡çŠ¶:**
```
ValueError: Adapter name furry_1748762952_4200 already in use in the Unet
```

**æ ¹æœ¬åŸå› :**
1. **æ¸…ç†ä¸å½»åº•**: ä¹‹å‰çš„é€‚é…å™¨æ®‹ç•™åœ¨å†…å­˜ä¸­
2. **å¼±å”¯ä¸€æ€§**: æ—¶é—´æˆ³+éšæœºæ•°ä»å¯èƒ½é‡å¤
3. **éšè—ç¼“å­˜**: PEFTé…ç½®ã€é€‚é…å™¨ç¼“å­˜æœªæ¸…ç†

**ä¿®å¤æ–¹æ¡ˆ:**

#### A. å½»åº•çš„é€‚é…å™¨æ¸…ç†
```python
def completely_clear_lora_adapters():
    # ç¬¬1å±‚ï¼šæ ‡å‡†æ¸…ç†
    pipe.unload_lora_weights()
    
    # ç¬¬2å±‚ï¼šæ·±åº¦æ¸…ç†PEFTé…ç½®
    unet.peft_config.clear()
    unet._lora_adapters.clear()
    
    # ç¬¬3å±‚ï¼šæ¸…ç†æ‰€æœ‰Text Encoderé€‚é…å™¨
    text_encoder._lora_adapters.clear()
    text_encoder_2._lora_adapters.clear()
    
    # ç¬¬4å±‚ï¼šGPUå†…å­˜æ¸…ç†
    torch.cuda.empty_cache()
```

#### B. å¼ºå”¯ä¸€æ€§é€‚é…å™¨åç§°
```python
# âŒ ä¹‹å‰çš„å¼±å”¯ä¸€æ€§
unique_adapter_name = f"{lora_id}_{int(time.time())}_{random.randint(1000, 9999)}"

# âœ… ä¿®å¤åçš„å¼ºå”¯ä¸€æ€§
import uuid
unique_id = str(uuid.uuid4())[:8]
timestamp = int(time.time() * 1000)  # æ¯«ç§’çº§
unique_adapter_name = f"{lora_id}_{timestamp}_{unique_id}"

# åŒé‡æ£€æŸ¥å†²çª
if unique_adapter_name in pipe.unet._lora_adapters:
    unique_adapter_name = f"{lora_id}_{timestamp}_{unique_id}_retry"
```

### 3. åŠ¨æ¼«æ¨¡å‹æ®‹å›¾é—®é¢˜ âŒ â†’ âœ…

**é—®é¢˜æè¿°:**
- åŠ¨æ¼«æ¨¡å‹ç”Ÿæˆçš„å›¾åƒè´¨é‡ä½ä¸‹ï¼Œå‡ºç°"æ®‹æ¬¡å“"
- å›¾åƒæ¨¡ç³Šã€ç»†èŠ‚ç¼ºå¤±ã€æ„å›¾é—®é¢˜

**æ ¹æœ¬åŸå› åˆ†æ:**
1. **åˆ†è¾¨ç‡è¿‡ä½**: ä½¿ç”¨512x512å¯¹SDXLæ¶æ„ä¸é€‚åˆ
2. **CFG Scaleä¸å½“**: è¿‡ä½å¯¼è‡´æŒ‡å¯¼ä¸è¶³
3. **æ­¥æ•°ä¸å¤Ÿ**: å»å™ªè¿‡ç¨‹ä¸å……åˆ†

**ä¿®å¤å‚æ•°:**
```python
# âŒ ä¹‹å‰çš„å‚æ•°ï¼ˆå®¹æ˜“äº§ç”Ÿæ®‹å›¾ï¼‰
min_resolution = 768x768
cfg_range = 5.0-8.0
steps_range = 15-35

# âœ… ä¿®å¤åçš„å‚æ•°ï¼ˆä¼˜åŒ–è´¨é‡ï¼‰
min_resolution = 1024x1024  # å¼ºåˆ¶æœ€å°åˆ†è¾¨ç‡
cfg_range = 6.0-9.0         # æ›´å¥½çš„æŒ‡å¯¼èŒƒå›´
steps_range = 25-40         # å……åˆ†çš„å»å™ªæ­¥æ•°

# è‡ªåŠ¨å‚æ•°è°ƒæ•´
if width < 1024: width = 1024
if height < 1024: height = 1024
if cfg_scale < 6.0: cfg_scale = 7.0
if steps < 25: steps = 25
```

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### ä¿®å¤å‰çš„å·¥ä½œæµç¨‹ âŒ
```
1. åŠ è½½åŸºç¡€æ¨¡å‹
2. è‡ªåŠ¨åŠ è½½é»˜è®¤LoRA (gayporn) 
3. ç”¨æˆ·é€‰æ‹©å…¶ä»–LoRA (furry)
4. å°è¯•æ¸…ç†æ—§LoRA (ä¸å½»åº•)
5. åŠ è½½æ–°LoRA â†’ åç§°å†²çªé”™è¯¯
6. ä½¿ç”¨ä½è´¨é‡å‚æ•°ç”Ÿæˆæ®‹å›¾
```

### ä¿®å¤åçš„å·¥ä½œæµç¨‹ âœ…
```
1. åŠ è½½åŸºç¡€æ¨¡å‹
2. ä¿æŒæ¸…æ´çŠ¶æ€ï¼Œæ— é»˜è®¤LoRA
3. ç”¨æˆ·é€‰æ‹©LoRA (furry)
4. å½»åº•æ¸…ç†(å¤šå±‚æ¸…ç†æœºåˆ¶)
5. ä½¿ç”¨UUIDç”Ÿæˆå”¯ä¸€é€‚é…å™¨å
6. åŠ è½½ç”¨æˆ·é€‰æ‹©çš„LoRA
7. ä½¿ç”¨ä¼˜åŒ–å‚æ•°ç”Ÿæˆé«˜è´¨é‡å›¾åƒ
```

### æ ¸å¿ƒä»£ç å˜æ›´

#### 1. ç§»é™¤è‡ªåŠ¨LoRAåŠ è½½
```python
# backend/handler.py
def load_specific_model(base_model_type: str):
    # âŒ åˆ é™¤äº†è¿™éƒ¨åˆ†
    # default_lora_path = model_config.get("lora_path")
    # txt2img_pipe.load_lora_weights(default_lora_path)
    
    # âœ… æ–°çš„æ¸…æ´æ–¹å¼
    print("â„¹ï¸  åŸºç¡€æ¨¡å‹åŠ è½½å®Œæˆï¼Œæ— é»˜è®¤LoRAï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©LoRA")
    current_lora_config = {}
    current_selected_lora = None
```

#### 2. å¼ºåŒ–é€‚é…å™¨æ¸…ç†
```python
# æ–°å¢UUIDå¯¼å…¥
import uuid

# å¼ºå”¯ä¸€æ€§é€‚é…å™¨åç§°
unique_id = str(uuid.uuid4())[:8]
timestamp = int(time.time() * 1000)
unique_adapter_name = f"{lora_id}_{timestamp}_{unique_id}"
```

#### 3. åŠ¨æ¼«æ¨¡å‹å‚æ•°ä¼˜åŒ–
```python
# å¼ºåˆ¶è´¨é‡å‚æ•°
if width < 1024: width = 1024
if height < 1024: height = 1024
if cfg_scale < 6.0: cfg_scale = 7.0
if steps < 25: steps = 25
```

## ğŸ“Š é¢„æœŸæ•ˆæœ

### LoRAåŠ è½½æµç¨‹
- âœ… **ç”¨æˆ·é€‰æ‹©å†³å®š**: ä¸å†è‡ªåŠ¨åŠ è½½é»˜è®¤LoRA
- âœ… **æ— å†²çªåŠ è½½**: å½»åº•æ¸…ç†+å”¯ä¸€å‘½å
- âœ… **å³æ—¶å“åº”**: ç”¨æˆ·é€‰æ‹©ä»€ä¹ˆå°±åŠ è½½ä»€ä¹ˆ

### å›¾åƒè´¨é‡
- âœ… **é«˜åˆ†è¾¨ç‡**: å¼ºåˆ¶1024x1024æœ€å°åˆ†è¾¨ç‡
- âœ… **ä¼˜åŒ–å‚æ•°**: CFG 6-9, Steps 25-40
- âœ… **ç¨³å®šç”Ÿæˆ**: é¿å…æ®‹å›¾å’Œè´¨é‡é—®é¢˜

### é”™è¯¯å¤„ç†
- âœ… **å¤šå±‚æ¸…ç†**: 4å±‚æ¸…ç†æœºåˆ¶ç¡®ä¿çŠ¶æ€æ¸…æ´
- âœ… **å†²çªæ£€æµ‹**: ä¸»åŠ¨æ£€æµ‹å¹¶é¿å…é€‚é…å™¨åç§°å†²çª
- âœ… **ä¼˜é›…é™çº§**: å¤±è´¥æ—¶æ¸…ç†çŠ¶æ€ï¼Œä¸å½±å“åŸºç¡€æ¨¡å‹

## ğŸ§ª æµ‹è¯•éªŒè¯

æ¨èæµ‹è¯•åœºæ™¯ï¼š
1. **çœŸäººæ¨¡å‹**: é€‰æ‹©ä¸åŒLoRAï¼ŒéªŒè¯åŠ è½½æ­£ç¡®æ€§
2. **åŠ¨æ¼«æ¨¡å‹**: æµ‹è¯•furry, gaypornç­‰LoRAåˆ‡æ¢
3. **è´¨é‡æµ‹è¯•**: 1024x1024åˆ†è¾¨ç‡ï¼ŒCFG=7ï¼Œsteps=25
4. **è¿ç»­åˆ‡æ¢**: å¤šæ¬¡åˆ‡æ¢LoRAï¼ŒéªŒè¯æ— å†²çª

---
*ä¿®å¤ç‰ˆæœ¬: v4.0*  
*ä¿®å¤æ—¥æœŸ: 2025-01-31*  
*æ¶µç›–é—®é¢˜: è‡ªåŠ¨LoRAåŠ è½½ã€é€‚é…å™¨å†²çªã€æ®‹å›¾è´¨é‡* 