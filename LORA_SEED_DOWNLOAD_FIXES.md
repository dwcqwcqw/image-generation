# LoRAåŠ è½½ã€ç§å­æ˜¾ç¤ºå’Œä¸‹è½½åŠŸèƒ½ä¿®å¤æ–‡æ¡£

## ä¿®å¤çš„é—®é¢˜

### 1. ğŸ”§ åŠ¨æ¼«LoRAåŠ è½½é”™è¯¯ä¿®å¤

**é—®é¢˜æè¿°:**
```
âŒ Error loading multiple LoRAs: Adapter name blowjob_handjob already in use in the Unet - please select a new adapter name.
```

**åŸå› åˆ†æ:**
- åŠ¨æ¼«æ¨¡å‹åœ¨åˆ‡æ¢LoRAæ—¶ï¼Œä¹‹å‰çš„é€‚é…å™¨æ²¡æœ‰è¢«å®Œå…¨æ¸…ç†
- diffusersåº“çš„æ–°ç‰ˆæœ¬å¯¹é€‚é…å™¨åç§°æœ‰æ›´ä¸¥æ ¼çš„å”¯ä¸€æ€§è¦æ±‚
- ç°æœ‰çš„`unload_lora_weights()`æ–¹æ³•ä¸èƒ½å®Œå…¨æ¸…é™¤æ‰€æœ‰é€‚é…å™¨çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ:**
1. **ä¸‰å±‚æ¸…ç†ç­–ç•¥**: 
   - æ–¹æ³•1: æ ‡å‡†`unload_lora_weights()`
   - æ–¹æ³•2: æ‰‹åŠ¨æ¸…ç†UNetçš„`_lora_adapters`å’Œ`peft_config`
   - æ–¹æ³•3: åˆ é™¤`peft_modules`å±æ€§

2. **å”¯ä¸€é€‚é…å™¨åç§°**: 
   - ä½¿ç”¨`{lora_id}_{timestamp}`æ ¼å¼é¿å…åç§°å†²çª
   - å¤šä¸ªLoRAä½¿ç”¨`{lora_id}_{timestamp}_{index}`æ ¼å¼

**ä¿®æ”¹å†…å®¹:**
```python
# ğŸš¨ ä¿®å¤ï¼šå½»åº•æ¸…ç†ç°æœ‰çš„LoRAé€‚é…å™¨
try:
    # æ–¹æ³•1: æ ‡å‡†unload_lora_weights
    txt2img_pipe.unload_lora_weights()
except Exception as e:
    print(f"âš ï¸  Standard unload failed: {e}")

try:
    # æ–¹æ³•2: ç›´æ¥æ¸…ç†UNetä¸­çš„é€‚é…å™¨
    if hasattr(txt2img_pipe, 'unet') and hasattr(txt2img_pipe.unet, '_lora_adapters'):
        txt2img_pipe.unet._lora_adapters.clear()
        if hasattr(txt2img_pipe.unet, 'peft_config'):
            txt2img_pipe.unet.peft_config.clear()
except Exception as e:
    print(f"âš ï¸  Manual adapter cleanup failed: {e}")

# ä½¿ç”¨å”¯ä¸€é€‚é…å™¨åç§°
unique_adapter_name = f"{lora_id}_{int(time.time())}"
txt2img_pipe.load_lora_weights(lora_path, adapter_name=unique_adapter_name)
```

### 2. ğŸ² åŠ¨æ¼«æ¨¡å‹ç§å­æ˜¾ç¤ºä¿®å¤

**é—®é¢˜æè¿°:**
```
ğŸ² å›¾åƒ 1 éšæœºç§å­
ğŸ² å›¾åƒ 2 éšæœºç§å­
```
- æ—¥å¿—åªæ˜¾ç¤º"éšæœºç§å­"æ–‡å­—ï¼Œæ²¡æœ‰æ˜¾ç¤ºå…·ä½“çš„ç§å­æ•°å€¼
- å½±å“ç”¨æˆ·å¤ç°ç‰¹å®šçš„ç”Ÿæˆç»“æœ

**åŸå› åˆ†æ:**
- åœ¨`seed == -1`çš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ç”Ÿæˆå…·ä½“çš„ç§å­å€¼
- åªæ˜¯æ‰“å°"éšæœºç§å­"è€Œæ²¡æœ‰è®°å½•å®é™…ä½¿ç”¨çš„ç§å­

**è§£å†³æ–¹æ¡ˆ:**
1. **éšæœºç§å­ç”Ÿæˆ**: ä¸ºseed == -1çš„æƒ…å†µç”Ÿæˆå…·ä½“çš„32ä½æ•´æ•°ç§å­
2. **å®Œæ•´æ—¥å¿—è®°å½•**: æ˜¾ç¤ºå®é™…ä½¿ç”¨çš„ç§å­å€¼ï¼ŒåŒ…æ‹¬éšæœºç”Ÿæˆçš„
3. **APIè¿”å›å€¼ä¿®å¤**: ç¡®ä¿è¿”å›çš„æ•°æ®ä¸­æ€»æ˜¯åŒ…å«å…·ä½“çš„ç§å­å€¼

**ä¿®æ”¹å†…å®¹:**
```python
if seed != -1:
    current_seed = seed + i
    print(f"ğŸ² å›¾åƒ {i+1} ç§å­: {current_seed}")
else:
    # ğŸš¨ ä¿®å¤ï¼šä¸ºéšæœºç§å­ç”Ÿæˆå…·ä½“çš„ç§å­å€¼å¹¶æ˜¾ç¤º
    import random
    current_seed = random.randint(0, 2147483647)  # ä½¿ç”¨32ä½æ•´æ•°èŒƒå›´
    generator = torch.Generator(device=txt2img_pipe.device).manual_seed(int(current_seed))
    current_generation_kwargs["generator"] = generator
    print(f"ğŸ² å›¾åƒ {i+1} ç§å­: {current_seed} (éšæœºç”Ÿæˆ)")

# è¿”å›ç»“æœä¸­æ€»æ˜¯åŒ…å«å…·ä½“ç§å­å€¼
'seed': current_seed  # ğŸš¨ ä¿®å¤ï¼šæ€»æ˜¯åŒ…å«å…·ä½“çš„ç§å­å€¼
```

### 3. ğŸ“¥ å‰ç«¯ä¸‹è½½åŠŸèƒ½ä¼˜åŒ–

**é—®é¢˜æè¿°:**
- ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æŒ‰é’®æ—¶ï¼Œæœ‰æ—¶ä¼šå…ˆæ‰“å¼€é¢„è§ˆé¡µé¢ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¸‹è½½
- éœ€è¦é¢å¤–çš„æ­¥éª¤æ‰èƒ½ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°

**åŸå› åˆ†æ:**
- æµè§ˆå™¨å¯¹ç›´æ¥é“¾æ¥ä¸‹è½½çš„å¤„ç†ç­–ç•¥ä¸ä¸€è‡´
- æŸäº›æƒ…å†µä¸‹æµè§ˆå™¨ä¼šæ‰“å¼€å›¾ç‰‡é¢„è§ˆè€Œä¸æ˜¯ä¸‹è½½
- ä¸‹è½½ç­–ç•¥çš„ä¼˜å…ˆçº§éœ€è¦è°ƒæ•´

**è§£å†³æ–¹æ¡ˆ:**
1. **ä¼˜å…ˆfetch+blobç­–ç•¥**: ä½¿ç”¨fetchè·å–å›¾ç‰‡æ•°æ®ï¼Œåˆ›å»ºblob URLè¿›è¡Œä¸‹è½½
2. **å¼ºåˆ¶ä¸‹è½½å±æ€§**: ç¡®ä¿`download`å±æ€§æ­£ç¡®è®¾ç½®ï¼Œé¿å…é¢„è§ˆæ¨¡å¼  
3. **éšè—ä¸‹è½½é“¾æ¥**: è®¾ç½®`display: none`é¿å…ç•Œé¢é—ªçƒ
4. **ç«‹å³æ¸…ç†**: ä¸‹è½½åç«‹å³ç§»é™¤ä¸´æ—¶å…ƒç´ å’Œblob URL

**ä¿®æ”¹å†…å®¹:**
```javascript
// ğŸš¨ ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨fetch+blobç­–ç•¥ï¼Œç¡®ä¿ç›´æ¥ä¸‹è½½è€Œä¸æ˜¯é¢„è§ˆ
const response = await fetch(originalUrl, {
  mode: 'cors',
  credentials: 'omit',
  headers: { 'Accept': 'image/*' },
})

if (response.ok) {
  const blob = await response.blob()
  const url = window.URL.createObjectURL(blob)
  
  // ğŸš¨ ä¿®å¤ï¼šä½¿ç”¨downloadå±æ€§å¼ºåˆ¶ä¸‹è½½ï¼Œé¿å…é¢„è§ˆ
  const link = document.createElement('a')
  link.href = url
  link.download = filename
  link.style.display = 'none'  // ç¡®ä¿ä¸‹è½½è€Œä¸æ˜¯é¢„è§ˆ
  
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  window.URL.revokeObjectURL(url)
}
```

## æµ‹è¯•éªŒè¯

### LoRAåŠ è½½æµ‹è¯•
- âœ… æˆåŠŸåˆ‡æ¢ä¸åŒçš„åŠ¨æ¼«LoRAè€Œä¸å‡ºç°é€‚é…å™¨å†²çª
- âœ… å¤šæ¬¡åŠ è½½åŒä¸€LoRAä¸ä¼šæŠ¥é”™
- âœ… LoRAæƒé‡æ­£ç¡®åº”ç”¨åˆ°ç”Ÿæˆç»“æœ

### ç§å­æ˜¾ç¤ºæµ‹è¯•  
- âœ… éšæœºç§å­æƒ…å†µä¸‹æ˜¾ç¤ºå…·ä½“çš„ç§å­æ•°å€¼
- âœ… æŒ‡å®šç§å­æƒ…å†µä¸‹æ˜¾ç¤ºæ­£ç¡®çš„é€’å¢ç§å­
- âœ… APIè¿”å›çš„ç§å­å€¼å¯ç”¨äºå¤ç°ç”Ÿæˆç»“æœ

### ä¸‹è½½åŠŸèƒ½æµ‹è¯•
- âœ… ç‚¹å‡»ä¸‹è½½æŒ‰é’®ç›´æ¥ä¸‹è½½å›¾ç‰‡ï¼Œæ— é¢„è§ˆæ­¥éª¤
- âœ… ä¸‹è½½çš„æ–‡ä»¶åæ­£ç¡®ï¼ŒåŒ…å«.pngæ‰©å±•å
- âœ… å¤šå¼ å›¾ç‰‡æ‰¹é‡ä¸‹è½½åŠŸèƒ½æ­£å¸¸

## éƒ¨ç½²çŠ¶æ€

æ‰€æœ‰ä¿®å¤å·²æ¨é€åˆ°GitHubå¹¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚ç”¨æˆ·ç°åœ¨å¯ä»¥ï¼š
1. æ­£å¸¸åˆ‡æ¢åŠ¨æ¼«LoRAæ¨¡å‹è€Œä¸é‡åˆ°åŠ è½½é”™è¯¯
2. åœ¨ç”Ÿæˆæ—¥å¿—å’Œè¿”å›æ•°æ®ä¸­çœ‹åˆ°å…·ä½“çš„ç§å­å€¼
3. ç‚¹å‡»ä¸‹è½½æŒ‰é’®ç›´æ¥ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°ï¼Œæ— éœ€é¢å¤–æ­¥éª¤ 