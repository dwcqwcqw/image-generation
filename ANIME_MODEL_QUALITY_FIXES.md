# åŠ¨æ¼«æ¨¡å‹ç”Ÿæˆè´¨é‡å’ŒLoRAåŠ è½½ä¿®å¤æ–‡æ¡£

## ğŸš¨ ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜

### 1. åŠ¨æ¼«æ¨¡å‹ç”Ÿæˆ"æ®‹æ¬¡å“"é—®é¢˜

**é—®é¢˜æè¿°:**
- åŠ¨æ¼«æ¨¡å‹ç”Ÿæˆçš„å›¾åƒè´¨é‡ä½ä¸‹ï¼Œå‡ºç°"æ®‹æ¬¡å“"
- å›¾åƒæ¨¡ç³Šã€ç»†èŠ‚ç¼ºå¤±ã€æ„å›¾é—®é¢˜

**æ ¹æœ¬åŸå› åˆ†æ:**
1. **åˆ†è¾¨ç‡è®¾ç½®ä¸å½“**: ä½¿ç”¨512x512åˆ†è¾¨ç‡å¯¹SDXLæ¨¡å‹æ¥è¯´è¿‡ä½
2. **CFG Scaleä¸åˆé€‚**: è¿‡ä½æˆ–è¿‡é«˜çš„CFGå¯¼è‡´ç”Ÿæˆè´¨é‡é—®é¢˜
3. **ç”Ÿæˆæ­¥æ•°ä¸è¶³**: æ­¥æ•°è¿‡ä½å¯¼è‡´å»å™ªä¸å……åˆ†
4. **ç¼ºä¹é’ˆå¯¹åŠ¨æ¼«æ¨¡å‹çš„ä¸“é—¨ä¼˜åŒ–**

**è§£å†³æ–¹æ¡ˆ:**
```python
# ğŸš¨ ä¿®å¤ï¼šä¼˜åŒ–åŠ¨æ¼«æ¨¡å‹å‚æ•°ï¼Œé¿å…æ®‹æ¬¡å“
# æ ¹æ®Anime_NSFW.safetensorsçš„å®˜æ–¹æ¨èå‚æ•°
if width < 768 or height < 768:
    print(f"âš ï¸  åŠ¨æ¼«æ¨¡å‹åˆ†è¾¨ç‡è¿‡ä½ ({width}x{height})ï¼Œè°ƒæ•´ä¸ºæœ€å°768x768")
    width = max(768, width)
    height = max(768, height)

# åŠ¨æ¼«æ¨¡å‹CFGä¼˜åŒ–
if cfg_scale < 6.0:
    print(f"âš ï¸  åŠ¨æ¼«æ¨¡å‹CFGè¿‡ä½ ({cfg_scale})ï¼Œè°ƒæ•´ä¸º7.0 (æ¨è6-9)")
    cfg_scale = 7.0
elif cfg_scale > 10.0:
    print(f"âš ï¸  åŠ¨æ¼«æ¨¡å‹CFGè¿‡é«˜ ({cfg_scale})ï¼Œè°ƒæ•´ä¸º7.5 (æ¨è6-9)")
    cfg_scale = 7.5

# åŠ¨æ¼«æ¨¡å‹æ­¥æ•°ä¼˜åŒ–
if steps < 20:
    print(f"âš ï¸  åŠ¨æ¼«æ¨¡å‹stepsè¿‡ä½ ({steps})ï¼Œè°ƒæ•´ä¸º25 (æ¨è20-35)")
    steps = 25
elif steps > 40:
    print(f"âš ï¸  åŠ¨æ¼«æ¨¡å‹stepsè¿‡é«˜ ({steps})ï¼Œè°ƒæ•´ä¸º35 (æ¨è20-35)")
    steps = 35
```

### 2. LoRAé€‚é…å™¨å†²çªé—®é¢˜

**é—®é¢˜æè¿°:**
```
âŒ Error loading multiple LoRAs: Adapter name sex_slave_1748761785 already in use in the Unet - please select a new adapter name.
```

**æ ¹æœ¬åŸå› åˆ†æ:**
1. **ä¸å®Œå…¨çš„é€‚é…å™¨æ¸…ç†**: åŸæœ‰çš„`unload_lora_weights()`ä¸èƒ½å®Œå…¨æ¸…é™¤æ‰€æœ‰é€‚é…å™¨çŠ¶æ€
2. **diffusersæ–°ç‰ˆæœ¬çš„ä¸¥æ ¼æ£€æŸ¥**: æ–°ç‰ˆæœ¬å¯¹é€‚é…å™¨åç§°å”¯ä¸€æ€§æœ‰æ›´ä¸¥æ ¼è¦æ±‚
3. **æ®‹ç•™çš„PEFTé…ç½®**: UNetä¸­çš„peft_configå’Œç›¸å…³å±æ€§æ²¡æœ‰è¢«æ¸…ç†

**è§£å†³æ–¹æ¡ˆ - ä¸‰å±‚æ¸…ç†ç­–ç•¥:**
```python
def completely_clear_lora_adapters():
    """å®Œå…¨æ¸…ç†æ‰€æœ‰LoRAé€‚é…å™¨ - æœ€å½»åº•çš„æ¸…ç†æ–¹æ³•"""
    
    # æ–¹æ³•1: æ ‡å‡†unload
    if hasattr(pipe, 'unload_lora_weights'):
        pipe.unload_lora_weights()
    
    # æ–¹æ³•2: æ¸…ç†UNeté€‚é…å™¨
    if hasattr(pipe, 'unet') and pipe.unet is not None:
        unet = pipe.unet
        
        # æ¸…ç†_lora_adapters
        if hasattr(unet, '_lora_adapters') and unet._lora_adapters:
            unet._lora_adapters.clear()
        
        # æ¸…ç†peft_config
        if hasattr(unet, 'peft_config') and unet.peft_config:
            unet.peft_config.clear()
        
        # æ¸…ç†æ‰€æœ‰adapterç›¸å…³å±æ€§
        adapter_attrs = ['_lora_adapters', 'peft_config', 'peft_modules', '_hf_peft_config_loaded']
        for attr in adapter_attrs:
            if hasattr(unet, attr):
                if attr.endswith('_loaded'):
                    setattr(unet, attr, False)
                else:
                    delattr(unet, attr)
    
    # æ–¹æ³•3: æ¸…ç†text encoderé€‚é…å™¨
    for encoder_name in ['text_encoder', 'text_encoder_2']:
        if hasattr(pipe, encoder_name):
            encoder = getattr(pipe, encoder_name)
            if encoder is not None and hasattr(encoder, '_lora_adapters'):
                if encoder._lora_adapters:
                    encoder._lora_adapters.clear()
                if hasattr(encoder, 'peft_config') and encoder.peft_config:
                    encoder.peft_config.clear()
```

### 3. é€‚é…å™¨åç§°å†²çªé—®é¢˜

**åŸæœ‰æ–¹æ¡ˆé—®é¢˜:**
```python
# é—®é¢˜ï¼šåªä½¿ç”¨æ—¶é—´æˆ³ï¼Œåœ¨å¿«é€Ÿåˆ‡æ¢æ—¶å¯èƒ½é‡å¤
unique_adapter_name = f"{lora_id}_{int(time.time())}"
```

**æ”¹è¿›æ–¹æ¡ˆ:**
```python
# ğŸš¨ ä¿®å¤ï¼šä½¿ç”¨æ›´å¼ºçš„å”¯ä¸€æ€§ä¿è¯
import time
import random
unique_adapter_name = f"{lora_id}_{int(time.time())}_{random.randint(1000, 9999)}"
```

## ğŸ“Š ä¼˜åŒ–å‚æ•°è¡¨

### åŠ¨æ¼«æ¨¡å‹æ¨èå‚æ•°

| å‚æ•° | æœ€å°å€¼ | æ¨èå€¼ | æœ€å¤§å€¼ | è¯´æ˜ |
|------|--------|--------|--------|------|
| åˆ†è¾¨ç‡ | 768x768 | 768x768 | 1024x1024+ | SDXLæ¨¡å‹æœ€å°æœ‰æ•ˆåˆ†è¾¨ç‡ |
| CFG Scale | 6.0 | 7.0 | 9.0 | å¹³è¡¡åˆ›æ„æ€§å’Œéµå¾ªåº¦ |
| Steps | 20 | 25 | 35 | å……åˆ†å»å™ªï¼Œé¿å…è¿‡åº¦è®¡ç®— |
| LoRAæƒé‡ | 0.5 | 0.8-1.0 | 1.0 | æ ¹æ®æ•ˆæœå¼ºåº¦è°ƒæ•´ |

### è´¨é‡é—®é¢˜å¯¹ç…§è¡¨

| é—®é¢˜ç—‡çŠ¶ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| å›¾åƒæ¨¡ç³Š | åˆ†è¾¨ç‡è¿‡ä½ | æå‡åˆ°768x768+ |
| ç»†èŠ‚ç¼ºå¤± | Stepsè¿‡ä½ | å¢åŠ åˆ°20-35æ­¥ |
| è¿‡åº¦é¥±å’Œ | CFGè¿‡é«˜ | é™ä½åˆ°6-9èŒƒå›´ |
| ç¼ºä¹åˆ›æ„ | CFGè¿‡ä½ | æå‡åˆ°6-7 |
| LoRAæ•ˆæœå¼± | æƒé‡è¿‡ä½ | è°ƒæ•´åˆ°0.8-1.0 |

## ğŸ§ª æµ‹è¯•éªŒè¯

å·²åˆ›å»º`test_anime_generation.py`è¯Šæ–­è„šæœ¬ï¼ŒåŒ…å«ï¼š

1. **ç”Ÿæˆè´¨é‡æµ‹è¯•**: éªŒè¯å‚æ•°ä¼˜åŒ–é€»è¾‘
2. **LoRAåŠ è½½æµ‹è¯•**: éªŒè¯é€‚é…å™¨æ¸…ç†æœºåˆ¶
3. **å‚æ•°è‡ªåŠ¨ä¿®æ­£æµ‹è¯•**: éªŒè¯ä½è´¨é‡å‚æ•°çš„è‡ªåŠ¨ä¼˜åŒ–

**æµ‹è¯•è¿è¡Œç»“æœ:**
```
ğŸ“Š æ€»ä½“ç»“æœ: 3/3 æµ‹è¯•é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿé…ç½®æ­£ç¡®ã€‚
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ç®¡ç†æ”¹è¿›
1. **å¼ºåˆ¶GPUå†…å­˜æ¸…ç†**: åœ¨é€‚é…å™¨æ¸…ç†åæ‰§è¡Œ`torch.cuda.empty_cache()`
2. **å¤±è´¥åçŠ¶æ€é‡ç½®**: LoRAåŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨æ¸…ç†çŠ¶æ€ï¼Œé¿å…æ®‹ç•™å½±å“
3. **ç®¡é“çŠ¶æ€åŒæ­¥**: ç¡®ä¿txt2imgå’Œimg2imgç®¡é“çŠ¶æ€ä¸€è‡´

### é”™è¯¯æ¢å¤æœºåˆ¶
```python
# ğŸš¨ ä¿®å¤ï¼šå³ä½¿LoRAåŠ è½½å¤±è´¥ï¼Œä¹Ÿè¦ç¡®ä¿çŠ¶æ€æ¸…ç†
try:
    completely_clear_lora_adapters()
    current_lora_config = {}
    print("ğŸ§¹ LoRAå¤±è´¥åçŠ¶æ€å·²æ¸…ç†")
except Exception as cleanup_error:
    print(f"âš ï¸  æ¸…ç†çŠ¶æ€å¤±è´¥: {cleanup_error}")
```

## ğŸš€ éƒ¨ç½²çŠ¶æ€

- âœ… ä¿®å¤å·²æ¨é€åˆ°GitHub
- âœ… ä¿®å¤å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- âœ… è¯Šæ–­æµ‹è¯•é€šè¿‡éªŒè¯
- âœ… å‚æ•°ä¼˜åŒ–ç”Ÿæ•ˆ

## ğŸ“ ä½¿ç”¨å»ºè®®

### å¯¹ç”¨æˆ·çš„å»ºè®®
1. **é¦–é€‰è®¾ç½®**: 768x768åˆ†è¾¨ç‡ï¼ŒCFG=7.0ï¼ŒSteps=25
2. **é«˜è´¨é‡è®¾ç½®**: 1024x1024åˆ†è¾¨ç‡ï¼ŒCFG=7.5ï¼ŒSteps=30
3. **LoRAæƒé‡**: å»ºè®®ä½¿ç”¨0.8-1.0çš„æƒé‡è·å¾—æ˜æ˜¾æ•ˆæœ
4. **æç¤ºè¯**: ä½¿ç”¨"masterpiece, best quality"ç­‰è´¨é‡æå‡è¯

### å¯¹å¼€å‘è€…çš„å»ºè®®
1. **ç›‘æ§é€‚é…å™¨æ¸…ç†**: å…³æ³¨æ—¥å¿—ä¸­çš„é€‚é…å™¨æ¸…ç†ä¿¡æ¯
2. **å‚æ•°éªŒè¯**: ç³»ç»Ÿä¼šè‡ªåŠ¨ä¼˜åŒ–ä¸åˆé€‚çš„å‚æ•°
3. **é”™è¯¯å¤„ç†**: LoRAåŠ è½½å¤±è´¥æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†çŠ¶æ€
4. **æ€§èƒ½ç›‘æ§**: æ³¨æ„GPUå†…å­˜ä½¿ç”¨æƒ…å†µ

## ğŸ” æ•…éšœæ’é™¤

### å¦‚æœä»ç„¶å‡ºç°LoRAé”™è¯¯
1. æ£€æŸ¥`completely_clear_lora_adapters()`æ˜¯å¦æ­£å¸¸æ‰§è¡Œ
2. éªŒè¯é€‚é…å™¨åç§°æ˜¯å¦ç¡®å®å”¯ä¸€
3. ç¡®è®¤UNetçŠ¶æ€æ˜¯å¦å®Œå…¨æ¸…ç†

### å¦‚æœç”Ÿæˆè´¨é‡ä»ç„¶ä¸ä½³
1. ç¡®è®¤åˆ†è¾¨ç‡æ˜¯å¦å·²è‡ªåŠ¨è°ƒæ•´åˆ°768+
2. æ£€æŸ¥CFGå’ŒStepsæ˜¯å¦åœ¨æ¨èèŒƒå›´å†…
3. éªŒè¯LoRAæ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å…¼å®¹

### å¦‚æœå‡ºç°å†…å­˜é”™è¯¯
1. ç¡®è®¤GPUå†…å­˜æ¸…ç†æ˜¯å¦æ‰§è¡Œ
2. é™ä½æ‰¹é‡ç”Ÿæˆæ•°é‡
3. è€ƒè™‘é™ä½åˆ†è¾¨ç‡åˆ°768x768

è¿™æ¬¡ä¿®å¤è§£å†³äº†åŠ¨æ¼«æ¨¡å‹çš„æ ¸å¿ƒè´¨é‡é—®é¢˜å’ŒLoRAåŠ è½½ç¨³å®šæ€§é—®é¢˜ï¼Œç”¨æˆ·ç°åœ¨åº”è¯¥èƒ½å¤Ÿè·å¾—é«˜è´¨é‡çš„åŠ¨æ¼«é£æ ¼å›¾åƒç”Ÿæˆç»“æœã€‚ 