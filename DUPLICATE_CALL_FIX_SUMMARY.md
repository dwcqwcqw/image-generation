# é‡å¤è°ƒç”¨å’Œè´Ÿé¢æç¤ºè¯é—®é¢˜ - æœ€ç»ˆä¿®å¤

## ğŸš¨ å‘ç°çš„æ ¹æœ¬é—®é¢˜

### 1. æ¶æ„æ€§é‡å¤è°ƒç”¨
**é—®é¢˜**: Handlerå‡½æ•°å’Œtext_to_imageå‡½æ•°éƒ½åœ¨è°ƒç”¨ç›¸åŒçš„ç”Ÿæˆå‡½æ•°ï¼Œå¯¼è‡´æ¯ä¸ªè¯·æ±‚è¢«å¤„ç†ä¸¤æ¬¡ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ handler() â†’ text_to_image() â†’ generate_diffusers_images()
         â†˜ ç›´æ¥è°ƒç”¨ â†’ generate_diffusers_images()  â† é‡å¤ï¼
```

**åæœ**: 
- æ¯ä¸ªè¯·æ±‚è¢«å¤„ç†2æ¬¡
- è´Ÿé¢æç¤ºè¯è¢«é‡å¤æ·»åŠ  
- æ—¥å¿—è¾“å‡ºä»å‡ KBå˜æˆå‡ ä¸‡KB
- ç³»ç»Ÿæ€§èƒ½ä¸¥é‡ä¸‹é™

### 2. è´Ÿé¢æç¤ºè¯ç–¯ç‹‚é‡å¤
**è§‚å¯Ÿåˆ°çš„ç°è±¡**:
```
negative_prompt: 'bad quality, worst quality, worst detail, sketch, censor, bad quality, worst quality, worst detail, sketch, censor, bad quality, worst quality...'
```
- åŸé•¿åº¦: 56å­—ç¬¦
- é‡å¤å: 38000+ tokensï¼
- æ¯20æ¯«ç§’å°±æœ‰ä¸€æ¬¡é‡å¤æ·»åŠ 

### 3. æ—¥å¿—çˆ†ç‚¸
**3ç§’å†…çš„é‡å¤è¾“å‡º**:
- `ğŸ” æœ€ç»ˆå‚æ•°æ£€æŸ¥`: 36æ¬¡
- `ğŸ¨ ä½¿ç”¨ anime æ¨¡å‹ç”Ÿæˆå›¾åƒ`: 36æ¬¡
- `ğŸ”§ å‹ç¼©prompt`: æ•°ç™¾æ¬¡

## âœ… å®æ–½çš„å½»åº•ä¿®å¤

### 1. æ¶æ„é‡æ„ - æ¶ˆé™¤é‡å¤è°ƒç”¨
**ä¿®å¤ä½ç½®**: `backend/handler.py:1898-1920`
```python
# ä¿®å¤å‰ (åŒé‡è°ƒç”¨):
if model_type == "flux":
    return generate_flux_images(...)
elif model_type == "diffusers":  
    return generate_diffusers_images(...)

# ä¿®å¤å (ç»Ÿä¸€è°ƒç”¨):
return text_to_image(
    prompt=prompt,
    negative_prompt=negative_prompt,
    # ... å…¶ä»–å‚æ•°
    base_model=current_base_model
)
```

### 2. å®Œå…¨ç¦ç”¨è‡ªåŠ¨è´Ÿé¢æç¤ºè¯
**ä¿®å¤ä½ç½®**: `backend/handler.py:750`
```python
# æ·»åŠ å¼€å…³å®Œå…¨ç¦ç”¨è‡ªåŠ¨æ·»åŠ 
auto_add_negative = False  # å®Œå…¨ç¦ç”¨è‡ªåŠ¨æ·»åŠ 

if auto_add_negative and recommended_negative not in negative_prompt:
    # åªæœ‰å½“å¼€å…³ä¸ºTrueæ—¶æ‰æ·»åŠ 
    ...
else:
    print(f"ğŸ”§ è‡ªåŠ¨æ·»åŠ è´Ÿé¢æç¤ºå·²ç¦ç”¨ï¼Œä¿æŒç”¨æˆ·åŸå§‹è¾“å…¥")
```

### 3. é˜²æ­¢é‡å¤æ£€æŸ¥æœºåˆ¶
**ä¿ç•™çš„å®‰å…¨æ£€æŸ¥**:
```python
if recommended_negative not in negative_prompt:
    # åªæœ‰åœ¨ä¸å­˜åœ¨æ—¶æ‰æ·»åŠ ï¼Œé˜²æ­¢é‡å¤
```

## ğŸ¯ ä¿®å¤æ•ˆæœé¢„æœŸ

### 1. æ¶ˆé™¤é‡å¤è°ƒç”¨
- âœ… æ¯ä¸ªè¯·æ±‚åªå¤„ç†ä¸€æ¬¡
- âœ… æ¶ˆé™¤åŒé‡è°ƒç”¨æ¶æ„é—®é¢˜
- âœ… ç»Ÿä¸€é€šè¿‡text_to_imageå¤„ç†

### 2. è´Ÿé¢æç¤ºè¯æ­£å¸¸åŒ–
- âœ… ä¸å†è‡ªåŠ¨æ·»åŠ æ¨èè´Ÿé¢æç¤ºè¯
- âœ… å®Œå…¨å°Šé‡ç”¨æˆ·è¾“å…¥ï¼ˆæˆ–ç©ºè¾“å…¥ï¼‰
- âœ… ä»38000+ tokensé™åˆ°ç”¨æˆ·åŸå§‹é•¿åº¦

### 3. æ—¥å¿—æ¸…ç†
- âœ… æ¯æ¬¡è¯·æ±‚åªç”Ÿæˆä¸€ç»„æ—¥å¿—
- âœ… æ¶ˆé™¤é‡å¤çš„å‹ç¼©å’Œå¤„ç†æ—¥å¿—
- âœ… æ€§èƒ½å’Œå¯è¯»æ€§å¤§å¹…æå‡

### 4. ç³»ç»Ÿæ€§èƒ½æ¢å¤
- âœ… CPUä½¿ç”¨é™ä½ï¼ˆæ¶ˆé™¤é‡å¤å¤„ç†ï¼‰
- âœ… å†…å­˜ä½¿ç”¨æ­£å¸¸åŒ–
- âœ… å›¾åƒç”Ÿæˆé€Ÿåº¦æ¢å¤æ­£å¸¸

## ğŸ” å…³é”®ä¿®å¤åŸç†

1. **å•ä¸€è´£ä»»**: Handleråªè´Ÿè´£è·¯ç”±ï¼Œå…·ä½“ç”Ÿæˆé€»è¾‘äº¤ç»™text_to_image
2. **ç”¨æˆ·ä¸»æƒ**: å®Œå…¨å°Šé‡ç”¨æˆ·çš„negative promptè¾“å…¥ï¼ˆåŒ…æ‹¬ç©ºè¾“å…¥ï¼‰
3. **æ¶æ„ç®€åŒ–**: æ¶ˆé™¤å¤æ‚çš„åŒé‡è°ƒç”¨é“¾
4. **æ€§èƒ½ä¼˜å…ˆ**: é¿å…ä»»ä½•ä¸å¿…è¦çš„é‡å¤æ“ä½œ

è¿™æ¬¡ä¿®å¤è§£å†³äº†ç³»ç»Ÿæ¶æ„å±‚é¢çš„æ ¹æœ¬é—®é¢˜ï¼Œè€Œä¸ä»…ä»…æ˜¯è¡¨é¢ç—‡çŠ¶ã€‚ 